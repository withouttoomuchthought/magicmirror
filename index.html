<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>magicmirror 🪞✨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Karla', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #F9E4A6 0%, #D4C5E2 50%, #B8C5B0 100%);
            background-size: 200% 200%;
            background-attachment: fixed;
            animation: gentleShift 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #3A3A3A;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        @keyframes gentleShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Subtle texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.03) 2px, rgba(255,255,255,.03) 4px);
            pointer-events: none;
            opacity: 0.5;
        }

        .container {
            width: 100%;
            max-width: 520px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        /* Debug panel */
        #debugPanel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }

        #debugPanel.active {
            display: block;
        }

        .debug-line {
            margin: 2px 0;
            word-break: break-all;
        }

        .debug-error {
            color: #ff4444;
        }

        .debug-success {
            color: #44ff44;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 9998;
            font-size: 12px;
        }

        /* Views */
        .view {
            text-align: center;
            animation: fadeIn 1s ease;
        }

        .view.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Logo */
        .logo {
            font-family: 'Georgia', serif;
            font-size: 2.8em;
            font-weight: 300;
            text-transform: lowercase;
            margin-bottom: 15px;
            color: #3A3A3A;
            text-shadow: 0 2px 8px rgba(255, 255, 255, 0.8);
            animation: logoFloat 4s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .emoji {
            font-size: 1.1em;
            margin-left: 8px;
        }

        .tagline {
            font-size: 1em;
            line-height: 1.6;
            margin-bottom: 40px;
            opacity: 0.85;
        }

        /* Glass card */
        .glass-card {
            background: rgba(255, 248, 240, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 35px 30px;
            box-shadow: 
                0 15px 50px rgba(0, 0, 0, 0.1),
                0 5px 15px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Textarea */
        textarea {
            width: 100%;
            min-height: 180px;
            padding: 22px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.7);
            font-family: 'Georgia', serif;
            font-size: 1.05em;
            line-height: 1.8;
            resize: none;
            color: #3A3A3A;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }

        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 
                inset 0 2px 15px rgba(184, 197, 176, 0.15),
                0 0 0 3px rgba(212, 197, 226, 0.2);
        }

        textarea::placeholder {
            color: rgba(58, 58, 58, 0.4);
            font-style: italic;
        }

        /* Submit button */
        .submit-btn {
            margin-top: 24px;
            padding: 18px 50px;
            background: linear-gradient(135deg, #B8C5B0 0%, #D4C5E2 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            text-transform: lowercase;
            transition: all 0.3s ease;
            box-shadow: 
                0 10px 30px rgba(184, 197, 176, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            width: 100%;
            animation: buttonGlow 3s ease infinite;
            letter-spacing: 0.5px;
        }

        @keyframes buttonGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(184, 197, 176, 0.45);
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Footer note */
        .footer-note {
            margin-top: 35px;
            font-size: 0.9em;
            color: rgba(58, 58, 58, 0.6);
            font-style: italic;
            line-height: 1.8;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        /* Loading view */
        .loading-view {
            display: none;
            text-align: center;
        }

        .loading-view.active {
            display: block;
        }

        .breathing-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4), rgba(212, 197, 226, 0.3));
            backdrop-filter: blur(15px);
            box-shadow: 
                inset 0 0 30px rgba(255, 255, 255, 0.5),
                0 10px 40px rgba(212, 197, 226, 0.3);
            animation: breathe 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
        }

        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.7;
            }
            50% { 
                transform: scale(1.1); 
                opacity: 1;
            }
        }

        .loading-text {
            font-size: 1.2em;
            color: rgba(58, 58, 58, 0.7);
            font-style: italic;
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Result view */
        .result-view {
            display: none;
        }

        .result-view.active {
            display: block;
        }

        .section-label {
            font-size: 0.85em;
            text-transform: lowercase;
            color: rgba(58, 58, 58, 0.5);
            margin-bottom: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .user-input-box {
            font-family: 'Georgia', serif;
            font-size: 0.95em;
            line-height: 1.8;
            color: rgba(58, 58, 58, 0.7);
            font-style: italic;
            padding: 22px;
            background: rgba(184, 197, 176, 0.12);
            backdrop-filter: blur(10px);
            border-radius: 18px;
            border-left: 4px solid rgba(184, 197, 176, 0.6);
            margin-bottom: 30px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .divider {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            margin: 30px 0;
        }

        .transformed-box {
            font-family: 'Georgia', serif;
            font-size: 1.2em;
            line-height: 2;
            color: #3A3A3A;
            text-transform: lowercase;
            padding: 32px;
            background: linear-gradient(135deg, 
                rgba(212, 197, 226, 0.25) 0%, 
                rgba(249, 228, 166, 0.25) 50%, 
                rgba(184, 197, 176, 0.2) 100%);
            background-size: 200% 200%;
            backdrop-filter: blur(15px);
            border-radius: 22px;
            font-style: italic;
            white-space: pre-line;
            margin-bottom: 25px;
            box-shadow: 
                inset 0 2px 10px rgba(255, 255, 255, 0.6),
                0 5px 20px rgba(212, 197, 226, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            animation: gentleGlow 6s ease-in-out infinite;
        }

        @keyframes gentleGlow {
            0%, 100% { 
                background-position: 0% 50%;
                box-shadow: inset 0 2px 10px rgba(255, 255, 255, 0.6), 0 5px 20px rgba(212, 197, 226, 0.15);
            }
            50% { 
                background-position: 100% 50%;
                box-shadow: inset 0 2px 15px rgba(255, 255, 255, 0.7), 0 8px 30px rgba(249, 228, 166, 0.25);
            }
        }

        .signature {
            font-size: 0.7em;
            color: rgba(58, 58, 58, 0.45);
            font-style: italic;
            text-align: center;
            padding-top: 18px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .ai-disclaimer {
            font-size: 0.75em;
            color: rgba(58, 58, 58, 0.5);
            font-style: italic;
            text-align: center;
            margin-top: 18px;
            line-height: 1.6;
        }

        /* Action buttons */
        .action-buttons {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .action-btn {
            padding: 18px 22px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.75);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-icon {
            font-size: 1.4em;
            flex-shrink: 0;
        }

        .action-content {
            flex: 1;
        }

        .action-title {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 4px;
            text-transform: lowercase;
            color: #3A3A3A;
        }

        .action-desc {
            font-size: 0.85em;
            color: rgba(58, 58, 58, 0.6);
            font-style: italic;
        }

        /* Try again button */
        .try-again-btn {
            margin-top: 25px;
            padding: 16px 40px;
            background: transparent;
            color: rgba(58, 58, 58, 0.7);
            border: 2px solid rgba(212, 197, 226, 0.4);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: lowercase;
            width: 100%;
            font-size: 1em;
            font-weight: 500;
        }

        .try-again-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(184, 197, 176, 0.6);
        }

        .try-again-btn:active {
            transform: scale(0.98);
        }

        /* Footer links */
        .footer-links {
            position: fixed;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            z-index: 100;
        }

        .footer-link {
            font-size: 0.75em;
            color: rgba(58, 58, 58, 0.4);
            text-decoration: none;
            font-style: italic;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 50px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .footer-link:hover {
            color: rgba(58, 58, 58, 0.7);
            background: rgba(255, 255, 255, 0.6);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .logo {
                font-size: 2.2em;
            }
            
            .glass-card {
                padding: 28px 24px;
            }
            
            textarea {
                min-height: 160px;
                font-size: 1em;
            }
            
            .transformed-box {
                font-size: 1.1em;
                padding: 26px;
            }
        }
    </style>
</head>
<body>
    <!-- Debug panel toggle -->
    <div class="debug-toggle" onclick="toggleDebug()">🐛 Debug</div>
    
    <!-- Debug panel -->
    <div id="debugPanel"></div>

    <div class="container">
        <!-- Submission view -->
        <div id="submissionView" class="view">
            <div class="logo">
                magicmirror<span class="emoji">🪞✨</span>
            </div>
            <p class="tagline">
                your truth, transformed withouttoomuchthought.
            </p>

            <div class="glass-card">
                <textarea 
                    id="userInput" 
                    placeholder="what's on your heart?" 
                    maxlength="500"
                ></textarea>
                <button class="submit-btn" id="submitBtn" onclick="submitThought()">
                    transform 🪞✨
                </button>
            </div>

            <p class="footer-note">
                write whatever you're feeling.<br>
                no filter. no perfection.<br>
                this is a safe space to be honest.<br><br>
                anonymous. safe. free. 💛
            </p>
        </div>

        <!-- Loading view -->
        <div id="loadingView" class="loading-view">
            <div class="breathing-circle">🪞</div>
            <p class="loading-text">holding your words gently...</p>
            <p class="loading-text" style="animation-delay: 0.5s;">seeing what you really mean...</p>
        </div>

        <!-- Result view -->
        <div id="resultView" class="result-view">
            <div class="glass-card">
                <div class="section-label">you wrote:</div>
                <div class="user-input-box" id="userInputDisplay"></div>
                
                <div class="divider"></div>
                
                <div class="section-label">here's what we hear you saying 🪞✨</div>
                <div class="transformed-box" id="transformedText"></div>
                
                <div class="signature">
                    transformed with love by magicmirror | a @withouttoomuchthought + claude creation 🪞✨
                </div>
                
                <p class="ai-disclaimer">
                    these reflections come from ai. take what resonates, leave what doesn't.<br>
                    trust your own truth first 💛
                </p>

                <div class="action-buttons">
                    <button class="action-btn" onclick="shareToSocial()">
                        <div class="action-icon">🌸</div>
                        <div class="action-content">
                            <div class="action-title">share your truth</div>
                            <div class="action-desc">tiktok story, instagram, anywhere you want</div>
                        </div>
                    </button>

                    <button class="action-btn" onclick="downloadArt()">
                        <div class="action-icon">🎨</div>
                        <div class="action-content">
                            <div class="action-title">download as art</div>
                            <div class="action-desc">save this as a beautiful reminder</div>
                        </div>
                    </button>
                </div>

                <button class="try-again-btn" onclick="tryAgain()">
                    share another truth 🪞
                </button>
            </div>
        </div>
    </div>

    <!-- Footer links -->
    <div class="footer-links">
        <a href="https://www.tiktok.com/@withouttoomuchthought" class="footer-link" target="_blank">@withouttoomuchthought</a>
        <a href="https://www.withouttoomuchthought.com" class="footer-link" target="_blank">withouttoomuchthought.com</a>
    </div>

    <script>
        // ===== DEBUG SYSTEM =====
        let debugLogs = [];
        let debugActive = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push({ timestamp, message, type });
            console.log(`[${timestamp}] ${message}`);
            
            if (debugActive) {
                updateDebugPanel();
            }
        }

        function toggleDebug() {
            debugActive = !debugActive;
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('active');
            
            if (debugActive) {
                updateDebugPanel();
            }
        }

        function updateDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.innerHTML = debugLogs.slice(-20).map(log => {
                const className = log.type === 'error' ? 'debug-error' : 
                                 log.type === 'success' ? 'debug-success' : '';
                return `<div class="debug-line ${className}">[${log.timestamp}] ${log.message}</div>`;
            }).join('');
            panel.scrollTop = panel.scrollHeight;
        }

        // ===== MAIN VARIABLES =====
        let currentUserInput = '';
        const WEBHOOK_URL = 'https://hook.us2.make.com/ds2oyv9bi33hoq4rcgobqht654qmh5kb';

        log('magicmirror loaded successfully');
        log(`Webhook URL: ${WEBHOOK_URL}`);

        // ===== SUBMIT THOUGHT FUNCTION =====
        async function submitThought() {
            const input = document.getElementById('userInput').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            
            log(`Submit clicked. Input length: ${input.length}`);
            
            if (!input) {
                log('Empty input, showing alert', 'error');
                alert('share something first, love 💛');
                return;
            }

            currentUserInput = input;
            submitBtn.disabled = true;
            
            // Switch to loading view
            log('Switching to loading view');
            document.getElementById('submissionView').classList.add('hidden');
            document.getElementById('loadingView').classList.add('active');
            
            try {
                log('Sending request to webhook...');
                log(`Request body: ${JSON.stringify({ original_text: input, user_ip: 'browser' })}`);
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        original_text: input,
                        user_ip: 'browser'
                    })
                });

                log(`Response status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                // Get the response text first
                const responseText = await response.text();
                log(`Response body (raw): ${responseText.substring(0, 200)}...`);
                
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    log(`Response parsed as JSON successfully`, 'success');
                    log(`JSON keys: ${Object.keys(data).join(', ')}`);
                } catch (e) {
                    log(`Failed to parse JSON: ${e.message}`, 'error');
                    throw new Error('Response is not valid JSON');
                }
                
                // Hide loading after a short delay
                setTimeout(() => {
                    document.getElementById('loadingView').classList.remove('active');

                    if (data.error) {
                        log(`Error from webhook: ${data.message}`, 'error');
                        alert(data.message);
                        document.getElementById('submissionView').classList.remove('hidden');
                        submitBtn.disabled = false;
                        return;
                    }
                    
                    // Check for transformed text
                    if (!data.transformed) {
                        log('No "transformed" field in response', 'error');
                        log(`Available fields: ${JSON.stringify(data)}`);
                        alert('Received a response, but no transformation found. Check debug panel.');
                        document.getElementById('submissionView').classList.remove('hidden');
                        submitBtn.disabled = false;
                        return;
                    }
                    
                    log(`Transformation received: ${data.transformed.substring(0, 100)}...`, 'success');
                    
                    // Show results
                    document.getElementById('userInputDisplay').innerText = `"${currentUserInput}"`;
                    document.getElementById('transformedText').innerText = data.transformed;
                    document.getElementById('resultView').classList.add('active');
                    
                    log('Result view displayed successfully', 'success');
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 3000); // 3 second loading animation

            } catch (error) {
                log(`Fetch error: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                
                document.getElementById('loadingView').classList.remove('active');
                alert(`something went wrong 💛\n\nError: ${error.message}\n\nCheck the debug panel for details.`);
                document.getElementById('submissionView').classList.remove('hidden');
                submitBtn.disabled = false;
            }
        }

        // ===== SHARE TO SOCIAL =====
        async function shareToSocial() {
            log('Share to social clicked');
            const canvas = createStoryCanvas();
            
            canvas.toBlob(async (blob) => {
                log(`Canvas created, blob size: ${blob.size} bytes`);
                
                // Try Web Share API first
                if (navigator.share && navigator.canShare) {
                    try {
                        const file = new File([blob], 'magicmirror-truth.png', { type: 'image/png' });
                        
                        if (navigator.canShare({ files: [file] })) {
                            log('Using Web Share API');
                            await navigator.share({
                                files: [file],
                                title: 'my truth, transformed',
                                text: 'shared from magicmirror 🪞✨'
                            });
                            
                            log('Share completed', 'success');
                            setTimeout(() => {
                                alert('🌸 sharing complete!\n\nif you chose tiktok, tap "story" to share 💛');
                            }, 300);
                            return;
                        }
                    } catch (error) {
                        log(`Web Share API failed: ${error.message}`);
                    }
                }
                
                // Fallback to download
                log('Falling back to download');
                downloadBlob(blob, 'magicmirror-truth.png');
                
                setTimeout(() => {
                    alert('💛 image saved!\n\nopen tiktok → tap + → upload → select image → story\n\nshare your truth 🪞✨');
                }, 100);
            }, 'image/png', 0.95);
        }

        // ===== DOWNLOAD AS ART =====
        function downloadArt() {
            log('Download art clicked');
            const canvas = createStoryCanvas();
            
            canvas.toBlob((blob) => {
                downloadBlob(blob, `magicmirror-${Date.now()}.png`);
                log('Download initiated', 'success');
                
                setTimeout(() => {
                    alert('🎨 your reflection has been saved!\n\nshare it if it speaks to you 💛');
                }, 100);
            }, 'image/png', 0.95);
        }

        // ===== CREATE STORY CANVAS =====
        function createStoryCanvas() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // TikTok Story dimensions
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#F9E4A6');
            gradient.addColorStop(0.33, '#D4C5E2');
            gradient.addColorStop(0.66, '#B8C5B0');
            gradient.addColorStop(1, '#F9E4A6');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Texture
            ctx.globalAlpha = 0.03;
            for (let i = 0; i < canvas.width; i += 3) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            
            // Card
            const margin = 100;
            const cardPadding = 70;
            const cardX = margin;
            const cardY = margin + 80;
            const cardWidth = canvas.width - (margin * 2);
            const cardHeight = canvas.height - (margin * 2) - 160;
            
            // Glass card background
            ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
            ctx.shadowBlur = 45;
            ctx.shadowOffsetY = 20;
            ctx.fillStyle = 'rgba(255, 248, 240, 0.95)';
            ctx.beginPath();
            ctx.roundRect(cardX, cardY, cardWidth, cardHeight, 35);
            ctx.fill();
            ctx.shadowColor = 'transparent';
            
            // Border
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Get transformed text
            const transformedText = document.getElementById('transformedText').innerText;
            const lines = transformedText.split('\n');
            
            // Text settings
            ctx.fillStyle = '#3A3A3A';
            ctx.font = 'italic 42px Georgia, serif';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            // Wrap text function
            function wrapText(lines, x, y, maxWidth, lineHeight) {
                let currentY = y;
                
                lines.forEach((line) => {
                    if (!line.trim()) {
                        currentY += lineHeight * 0.5;
                        return;
                    }
                    
                    const words = line.split(' ');
                    let currentLine = '';
                    
                    words.forEach((word) => {
                        const testLine = currentLine + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        
                        if (metrics.width > maxWidth && currentLine !== '') {
                            ctx.fillText(currentLine.trim(), x, currentY);
                            currentLine = word + ' ';
                            currentY += lineHeight;
                        } else {
                            currentLine = testLine;
                        }
                    });
                    
                    if (currentLine.trim()) {
                        ctx.fillText(currentLine.trim(), x, currentY);
                        currentY += lineHeight;
                    }
                });
            }
            
            // Draw text
            const textX = cardX + cardPadding;
            const textY = cardY + cardPadding;
            const textMaxWidth = cardWidth - (cardPadding * 2);
            const lineHeight = 60;
            
            wrapText(lines, textX, textY, textMaxWidth, lineHeight);
            
            // Divider
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(cardX + 100, cardY + cardHeight - 140);
            ctx.lineTo(cardX + cardWidth - 100, cardY + cardHeight - 140);
            ctx.stroke();
            
            // Signature
            ctx.textAlign = 'center';
            ctx.font = '26px Georgia, serif';
            ctx.fillStyle = 'rgba(58, 58, 58, 0.6)';
            ctx.fillText('transformed with love by magicmirror 🪞✨', 
                canvas.width / 2, cardY + cardHeight - 95);
            
            ctx.font = '22px sans-serif';
            ctx.fillStyle = 'rgba(58, 58, 58, 0.55)';
            ctx.fillText('@withouttoomuchthought + claude', 
                canvas.width / 2, cardY + cardHeight - 55);
            
            return canvas;
        }

        // ===== HELPER FUNCTIONS =====
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function tryAgain() {
            log('Try again clicked');
            document.getElementById('resultView').classList.remove('active');
            document.getElementById('submissionView').classList.remove('hidden');
            document.getElementById('userInput').value = '';
            document.getElementById('submitBtn').disabled = false;
            currentUserInput = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== KEYBOARD SHORTCUT =====
        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitThought();
            }
        });

        // Log when page is fully loaded
        window.addEventListener('load', () => {
            log('Page fully loaded and ready', 'success');
        });
    </script>
</body>
</html>
